<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_invoice_timesheet_document">
        <t t-call="report.external_layout">
            <t t-set="o" t-value="o.with_context({'lang':o.partner_id.lang})" />
            <div class="page">

                <t t-foreach="o.invoice_line_ids" t-as="invoice_line">
                    <t t-if="invoice_line.product_id.hour_block">
                        <t t-foreach="invoice_line.sale_line_ids" t-as="sale_line">
                            <t t-foreach="sale_line.tasks_ids" t-as="task">
                                <div class="row">
                                    <h1 class="text-center">Maintenance And Support Summary</h1>
                                </div>
                                <div class="row mt32 mb32">
                                    <div class="col-xs-2" t-if="invoice_line.name">
                                        <strong>Description:</strong>
                                        <p t-field="invoice_line.name" />
                                    </div>
                                    <div class="col-xs-2" t-if="o.date_invoice">
                                        <strong>Invoice date:</strong>
                                        <p t-field="o.date_invoice" />
                                    </div>
                                    <div class="col-xs-2">
                                        <strong>Report date:</strong>
                                        <p><span t-esc="context_timestamp(datetime.datetime.now()).strftime('%d/%m/%Y')"/></p>
                                    </div>
                                    <div class="col-xs-2" t-if="o.number">
                                        <strong>Invoice:</strong>
                                        <p t-field="o.number" />
                                    </div>
                                    <div class="col-xs-2" t-if="invoice_line.quantity">
                                        <strong>Quantity invoiced :</strong>
                                        <p t-esc="'%02d:%02d' % (int(invoice_line.quantity), invoice_line.quantity % 1 * 60)" />
                                    </div>
                                    <div class="col-xs-2" t-if="sale_line.qty_delivered">
                                        <strong>Quantity delivered:</strong>
                                        <p t-esc="'%02d:%02d' % (int(sale_line.qty_delivered), sale_line.qty_delivered % 1 * 60)" />
                                    </div>
                                    <div class="col-xs-2" t-if="task.remaining_hours">
                                        <strong>Remaining hours:</strong>
                                        <p t-esc="'%02d:%02d' % (int(task.remaining_hours), task.remaining_hours % 1 * 60)" />
                                    </div>
                                </div>

                                <table class="table table-condensed">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>User</th>
                                            <th>Description</th>
                                            <th class="text-right">Quantity</th>
                                        </tr>
                                    </thead>
                                    <tbody class="invoice_tbody">
                                        <tr t-foreach="task.timesheet_ids" t-as="ts">
                                            <td><span t-field="ts.date"/></td>
                                            <td><span t-field="ts.user_id"/></td>
                                            <td><span t-field="ts.name"/></td>
                                            <td class="text-right">
                                                <span t-esc="'%02d:%02d' % (int(ts.unit_amount), ts.unit_amount % 1 * 60)" />
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </t>
                        <div style="page-break-after:always;" />
                        </t>
                    </t>
                </t>
            </div>
        </t>
    </template>

    <template id="report_invoice_timesheet">
        <t t-call="report.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-call="invoice_timesheet_report.report_invoice_timesheet_document" t-lang="o.partner_id.lang"/>
            </t>
        </t>
    </template>

    <report id="account_invoice_timesheets"
            model="account.invoice"
            string="Invoice Timesheets"
            report_type="qweb-pdf"
            name="invoice_timesheet_report.report_invoice_timesheet"
            file="invoice_timesheet_report.report_invoice_timesheet"
        />
</odoo>
